<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ESP32 LED Controller - Januar</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Arial", sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
      }

      .container {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 40px;
        box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        text-align: center;
        max-width: 400px;
        width: 100%;
        animation: fadeInUp 0.6s ease;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      h1 {
        color: #333;
        margin-bottom: 30px;
        font-size: 24px;
        font-weight: bold;
      }

      .status {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 30px;
        border-left: 4px solid #dc3545;
      }

      .status.connected {
        border-left-color: #28a745;
      }

      #bleState {
        font-weight: bold;
        font-size: 16px;
      }

      .btn {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 15px 30px;
        border-radius: 12px;
        cursor: pointer;
        font-size: 16px;
        font-weight: bold;
        margin: 8px;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        min-width: 120px;
      }

      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      }

      .btn:active {
        transform: translateY(0);
      }

      .btn:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-connect {
        background: linear-gradient(45deg, #28a745, #20c997);
      }

      .btn-disconnect {
        background: linear-gradient(45deg, #dc3545, #fd7e14);
      }

      .btn-on {
        background: linear-gradient(45deg, #28a745, #20c997);
      }

      .btn-off {
        background: linear-gradient(45deg, #dc3545, #fd7e14);
      }

      .led-controls {
        margin-top: 30px;
        padding-top: 30px;
        border-top: 1px solid #eee;
      }

      .led-status {
        margin-top: 20px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
        color: #666;
      }

      .connection-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-bottom: 20px;
      }

      .led-buttons {
        display: flex;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      h2 {
        color: #333;
        font-size: 18px;
        margin-bottom: 15px;
      }

      .info {
        color: #666;
        font-size: 12px;
        margin-top: 20px;
        line-height: 1.4;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>🔌 ESP32 LED Controller</h1>

      <div class="status" id="statusContainer">
        <div>
          Status: <span id="bleState" style="color: #dc3545">Disconnected</span>
        </div>
      </div>

      <div class="connection-buttons">
        <button class="btn btn-connect" id="connectBleButton">Connect</button>
        <button class="btn btn-disconnect" id="disconnectBleButton" disabled>
          Disconnect
        </button>
      </div>

      <div class="led-controls">
        <h2>💡 LED Control</h2>
        <div class="led-buttons">
          <button class="btn btn-on" id="onButton" disabled>ON</button>
          <button class="btn btn-off" id="offButton" disabled>OFF</button>
        </div>

        <div class="led-status">
          Status LED: <span id="ledStatus">Unknown</span>
        </div>
      </div>

      <div class="info">
        Device: ESP32Januar<br />
        UUID: c0fbfe47-def8-4a4e-b5d6-1eadcf675784
      </div>
    </div>

    <script>
      // DOM Elements
      const connectButton = document.getElementById("connectBleButton");
      const disconnectButton = document.getElementById("disconnectBleButton");
      const onButton = document.getElementById("onButton");
      const offButton = document.getElementById("offButton");
      const bleStateContainer = document.getElementById("bleState");
      const statusContainer = document.getElementById("statusContainer");
      const ledStatus = document.getElementById("ledStatus");

      // Device Configuration
      const deviceName = "ESP32Januar";
      const bleService = "c0fbfe47-def8-4a4e-b5d6-1eadcf675784";
      // Biasanya LED characteristic berbeda dari service UUID
      // Coba beberapa kemungkinan UUID characteristic
      const ledCharacteristic = "c0fbfe47-def8-4a4e-b5d6-1eadcf675784"; // UUID + 1
      const ledCharacteristicAlt = "c0fbfe47-def8-4a4e-b5d6-1eadcf675784"; // UUID yang sama

      // Global Variables
      let bleServer;
      let bleServiceFound;
      let ledCharacteristicFound;

      // Event Listeners
      connectButton.addEventListener("click", () => {
        if (isWebBluetoothEnabled()) {
          connectToDevice();
        }
      });

      disconnectButton.addEventListener("click", disconnectDevice);
      onButton.addEventListener("click", () => writeToLED(1));
      offButton.addEventListener("click", () => writeToLED(0));

      // Check Web Bluetooth Support
      function isWebBluetoothEnabled() {
        if (!navigator.bluetooth) {
          alert("Web Bluetooth tidak didukung di browser ini!");
          bleStateContainer.innerHTML = "Web Bluetooth tidak didukung";
          return false;
        }
        return true;
      }

      // Connect to ESP32
      function connectToDevice() {
        console.log("Mencari ESP32...");
        updateStatus("Connecting...", "#ffc107");

        navigator.bluetooth
          .requestDevice({
            filters: [{ name: deviceName }],
            optionalServices: [bleService],
          })
          .then((device) => {
            console.log("Device found:", device.name);
            device.addEventListener("gattserverdisconnected", onDisconnected);
            return device.gatt.connect();
          })
          .then((gattServer) => {
            bleServer = gattServer;
            console.log("Connected to GATT Server");
            return bleServer.getPrimaryService(bleService);
          })
          .then((service) => {
            bleServiceFound = service;
            console.log("Service found:", service.uuid);

            // Coba dapatkan semua characteristics yang tersedia
            return service.getCharacteristics();
          })
          .then((characteristics) => {
            console.log("Available characteristics:");
            characteristics.forEach((char) => {
              console.log("- UUID:", char.uuid);
              console.log("- Properties:", char.properties);
            });

            // Coba cari characteristic untuk LED (biasanya yang bisa di-write)
            let ledChar = characteristics.find(
              (char) =>
                char.properties.write || char.properties.writeWithoutResponse
            );

            if (!ledChar) {
              // Jika tidak ada yang bisa write, ambil yang pertama
              ledChar = characteristics[0];
            }

            if (!ledChar) {
              throw new Error("No suitable characteristic found");
            }

            ledCharacteristicFound = ledChar;
            console.log("Using LED Characteristic:", ledChar.uuid);
            console.log("Characteristic properties:", ledChar.properties);

            updateStatus("Connected", "#28a745");
            updateButtons(true);
            ledStatus.textContent = "Ready";
          })
          .catch((error) => {
            console.error("Connection error:", error);
            updateStatus("Connection Failed", "#dc3545");
            alert("Gagal terhubung ke ESP32. Pastikan device sudah aktif!");
          });
      }

      // Handle Disconnection
      function onDisconnected(event) {
        console.log("Device disconnected");
        updateStatus("Disconnected", "#dc3545");
        updateButtons(false);
        ledStatus.textContent = "Unknown";
      }

      // Write to LED Characteristic
      function writeToLED(value) {
        console.log("Attempting to write LED value:", value);

        if (!bleServer || !bleServer.connected) {
          alert("ESP32 belum terhubung!");
          return;
        }

        if (!ledCharacteristicFound) {
          alert("LED characteristic tidak ditemukan!");
          return;
        }

        try {
          // Coba beberapa format data
          let dataToSend;

          if (ledCharacteristicFound.properties.writeWithoutResponse) {
            // Gunakan writeWithoutResponse jika tersedia
            console.log("Using writeValueWithoutResponse");
            dataToSend = new Uint8Array([value]);

            ledCharacteristicFound
              .writeValueWithoutResponse(dataToSend)
              .then(() => {
                console.log("LED command sent successfully:", value);
                ledStatus.textContent = value ? "ON ✅" : "OFF ❌";
                ledStatus.style.color = value ? "#28a745" : "#dc3545";
              })
              .catch((error) => {
                console.error("Error with writeValueWithoutResponse:", error);
                // Fallback ke writeValue
                tryWriteValue(value);
              });
          } else if (ledCharacteristicFound.properties.write) {
            // Gunakan write biasa
            tryWriteValue(value);
          } else {
            alert("Characteristic tidak mendukung write operation!");
            console.error(
              "Characteristic properties:",
              ledCharacteristicFound.properties
            );
          }
        } catch (error) {
          console.error("Error in writeToLED:", error);
          alert("Error mengirim command: " + error.message);
        }
      }

      function tryWriteValue(value) {
        console.log("Using writeValue");
        const dataToSend = new Uint8Array([value]);

        ledCharacteristicFound
          .writeValue(dataToSend)
          .then(() => {
            console.log("LED command sent successfully:", value);
            ledStatus.textContent = value ? "ON ✅" : "OFF ❌";
            ledStatus.style.color = value ? "#28a745" : "#dc3545";
          })
          .catch((error) => {
            console.error("Error with writeValue:", error);
            alert("Gagal mengirim perintah ke LED: " + error.message);

            // Coba format data alternatif
            console.log("Trying alternative data formats...");
            tryAlternativeFormats(value);
          });
      }

      function tryAlternativeFormats(value) {
        // Coba format string
        const stringData = new TextEncoder().encode(value.toString());

        ledCharacteristicFound
          .writeValue(stringData)
          .then(() => {
            console.log("LED command sent with string format:", value);
            ledStatus.textContent = value ? "ON ✅" : "OFF ❌";
            ledStatus.style.color = value ? "#28a745" : "#dc3545";
          })
          .catch((error) => {
            console.error("All write methods failed:", error);
            alert("Semua metode pengiriman gagal. Periksa ESP32 code!");
          });
      }

      // Disconnect Device
      function disconnectDevice() {
        if (bleServer && bleServer.connected) {
          bleServer.disconnect();
          updateStatus("Disconnected", "#dc3545");
          updateButtons(false);
          ledStatus.textContent = "Unknown";
          console.log("Device disconnected manually");
        }
      }

      // Update Connection Status
      function updateStatus(status, color) {
        bleStateContainer.textContent = status;
        bleStateContainer.style.color = color;

        if (status === "Connected") {
          statusContainer.classList.add("connected");
        } else {
          statusContainer.classList.remove("connected");
        }
      }

      // Update Button States
      function updateButtons(connected) {
        connectButton.disabled = connected;
        disconnectButton.disabled = !connected;
        onButton.disabled = !connected;
        offButton.disabled = !connected;
      }

      // Initialize page
      updateButtons(false);
    </script>
  </body>
</html>